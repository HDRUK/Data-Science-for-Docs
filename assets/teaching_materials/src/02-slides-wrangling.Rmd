---
title: "Data Wrangling"
author: "Edward Palmer"
institute: "The DataSciBC"
date: "2019/09/17 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

class: inverse, center, middle

# Lesson #4: Data Wrangling

---

# Learning Objectives

By the end of this session, you should be able to:
- Use the **tidyverse** package to build your first data pipeline
- Perform basic data manipulation tasks
- Inspect and summarise data

---

background-image: url(../img/tidyverse.png)

---

# The Tidyverse

> The tidyverse is a set of packages that work in harmony because they share common data representations... The tidyverse package is designed to make it easy to install and load core packages from the tidyverse in a single command.

---

# The Tidyverse

Running `library(tidyverse)` will load the following packages:
- `readr`, for data import.
- `dplyr`, for data manipulation.
- `tidyr`, for data tidying.
- `ggplot2`, for data visualisation.
- `purrr`, for functional programming.
- `tibble`, for tibbles, a modern re-imagining of data frames.
- `stringr`, for strings.
- `forcats`, for factors.

We are going to give an overview of the first four packages. The others you will encounter as you develop your skills.

---

# The Missing Package

There is no package in the tidyverse for dealing with dates and times. This is the `lubridate` package.

For various reasons, `lubridate` is not included in `tidyverse`, but it is written by the same developers and follows the same principles.

---

class: inverse, center, middle

# Load the tidyverse

---

```{r}
library(tidyverse)
library(lubridate)
```

---

# Import the Course Data

We have already included data in your RStudio instance.
To import this into R, we simply need to run a function and that read the csv files: `read_csv()`.

```{r, include = FALSE}
df <- read_csv("../../../_episodes_rmd/data/synthetic_data_clean.csv")
```

```{r, eval = FALSE}
df <- read_csv("./data/synthetic_data_clean.csv")
```

---

# Inspect the Data

- Most hard work already done.
- Tables are nearly in a "tidy" format.
- Tidy data means:
  - Each column is a variable.
  - Each row is an observation.

---

```{r}
df
```

---

Another very powerful way to view the data is to use the `glimpse` function

---

```{r}
glimpse(df)
```

---

# Data Wrangling: dplyr

A useful _grammar_ for data manipulation.

First, let's _filter_ the demographic data by row

```{r}
filter(df, height >= 1.8)
```

---

This _filters_ rows from the `demo_df` data frame where `height` is greater than or equal to `1.8`m.

---

# Notes on comparisons

- `==`
- `!=`
- `>=`
- `>`
- `<=`
- `<`
- `%in%`

---

Filter **always** acts on rows.
Will throw away any data that doesn't meet your request.

---

```{r}
include_graphics("./img/filter.png")
```

---

A similar function called `select` acts over columns. Just want the `sex` colum?

```{r}
select(df, sex)
```

---

```{r}
include_graphics("./img/select.png")
```

---

class: inverse, center, middle

# The Pipe

---

background-image: url(../img/pipe.jpeg)

---

# The Pipe

Now here comes the _proper_ magic. What if you want to both filter and select?

```{r}
df %>%
  filter(height >= 1.8) %>%
  select(sex)
```

---

The `%>%` operator is called a **pipe**
It _pipes_ data from one function to the next

```
data %>%
  do_this() %>%
  then_this() %>%
  and_this()
```

---

If we want to save the output of the pipe
Use the assignment operator at the start

```
data <- data %>%
  do_this() %>%
  then_this() %>%
  and_this()
```

remember that order matters.
The benefit of writing code like this:
- start with data
- each line is a single function that performs an action.
- This is the start of a data pipeline.

---

```{r}
# Tally by a group
df %>%
  filter(height >= 1.8) %>%
  select(sex) %>%
  group_by(sex) %>%
  tally()
```

---

# Verbs to rememebr

1. `arrange` - orders data using a named column
1. `group_by`- sets a column to be a grouping variable
1. `summarise`- summarises data over a grouping variable
1. `mutate` - add a new column to the data

Armed with only these 6 functions, you can accomplish a huge amount that would be tiresome and frustrating in excel.

---

```{r}
df %>%
  select(height, weight, sex) %>%
  arrange(height)
```

---

```{r}
include_graphics("./img/arrange.png")
```

---

```{r}
df %>%
  group_by(sex)
```

on it's own, `group_by` doesn't really accomplish anything useful. The utility is apparant when we combine with a summary function.

---

```{r}
df %>%
  group_by(sex) %>%
  summarise(average_height = mean(height, na.rm = TRUE))
```

---

```{r}
include_graphics("./img/group_by.png")
```

---

```{r}
include_graphics("./img/summarise.png")
```

---

```{r}
df %>%
  mutate(bmi = weight / height^2)
```

---

```{r}
include_graphics("./img/mutate.png")
```

---

```{r}
df %>%
  mutate(bmi = weight / height^2) %>%
  select(weight, height, bmi) %>%
  arrange(desc(bmi))
```

---

# Exercise

Use the functions you have just learnt to:
- Find the mean apache score for survivors and non-survivors
- Create a new column with the highest temp from temp_c and temp_nc

---

## Data Cleaning

```{r}
names(df)
```

---

Some of these variable names are too vague for my liking.
- chemo: active or historical?
- na: too similar to the R concept of "missing" i.e. NA
- system: a little ambiguous

```{r, eval = FALSE}
df <- df %>%
  rename(new_name = old_name)
```

---

```{r}
df <- df %>%
  rename(chemo_6_months = chemo,
         sodium = na,
         organ_system = system)
```

---

# Wrangling strings

## Extracting Numbers

```{r}
df %>%
  mutate(lactate_abg = parse_number(lactate_abg))
```

---

# Parsing dates

```{r}
df <- df %>%
  mutate(los = interval(arrival_dttm, discharge_dttm) / days(1))

df %>%
  select(los)
```

---

## Pivoting Data

```{r}
df_long <- df %>%
  pivot_longer(
    cols = c("lactate_1hr", "lactate_6hr", "lactate_12hr"),
    names_to = "lactate_time",
    values_to = "lactate_value") %>%
  select(id, lactate_time, lactate_value)
```

---

### Exercise

Use the functions you have just learnt to:
- Find the mean los for survivors and non-survivors
- Calculate the age on arrival for these patients
